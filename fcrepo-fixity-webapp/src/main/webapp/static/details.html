<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<script src="js/jquery-1.9.1.js"></script>
	<script src="js/jquery-ui-1.10.1.custom.min.js"></script>
	<script src="js/jquery.dataTables.min.js"></script>
	<script src="js/raphael.js"></script>
	<script src="js/g.raphael-min.js"></script>
	<script src="js/g.pie-min.js"></script>
	<script>
	$(document).ready(function() {
	    var numErrors=0;
	    var numSuccesses=0;
		
		$.extend({
	        getUrlVars: function(){
	          var vars = [], hash;
	          var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
	          for(var i = 0; i < hashes.length; i++)
	          {
	            hash = hashes[i].split('=');
	            vars.push(hash[0]);
	            vars[hash[0]] = hash[1];
	          }
	          return vars;
	        },
	        getUrlVar: function(name){
	          return $.getUrlVars()[name];
	        }
	      });
	
	    
		$.getJSON('../rest/results/details/' + $.getUrlVar("id"), function(data) {
			
			var aaData = new Array();
			counter = 0;

			
			if (!$.isEmptyObject(data['fixity-result']['errors'])){
				errorData = data['fixity-result']['errors'];
				
				if ($.isArray(data['fixity-result']['errors']['errors'])){
					errorData = data['fixity-result']['errors']['errors'];
				}
				
				$.each(errorData, function(key, value){
					var row = new Array();
					numErrors++;
					row[0] = value['@record-id'];
					row[1] = value['@datastream-id'];
					row[2] = value['@timestamp'];
					row[3] = value['@type'];
					row[4] = value['details'];
					aaData[counter++] = row;
				});
			}

			if (!$.isEmptyObject(data['fixity-result']['successes'])){
				successData = data['fixity-result']['successes'];
				console.log(successData);
				
				if ($.isArray(data['fixity-result']['successes']['successes'])){
					successData = data['fixity-result']['successes']['successes'];
				}
				
				$.each(successData, function(key, value){
						var row = new Array();
						console.log(value);
						numSuccesses++;
						row[0] = value['@record-id'];
						row[1] = value['@datastream-id'];
						row[2] = value['@timestamp'];
						row[3] = value['@type'];
						row[4] = value['details'];
						aaData[counter++] = row;
				});
			}

			$('#details').dataTable({
				aaData : aaData,
				iDisplayLength: 25,
				bJQueryUI : true,
				aoColumns : [ {sWwidth : "5%"},
				              {sWidth : "30%"},
				              {sWidth : "35%"},
				              {sWwidth : "10%"},
				              {sWwidth : "20%"}]
			});
			createPieChart(numSuccesses, numErrors);
		});
	});
	
	function createPieChart(numSuccesses, numErrors) {
		$('#piechart').empty();
		var r = Raphael("piechart");
		var chart_data = new Array();
		var colors = new Array();
		var legend = new Array();
		var count = 0;
		if (numSuccesses > 0){
			chart_data[count] = numSuccesses;
			legend[count] = '%%.%% - Success'; 
			colors[count++] = '#00ff00'; 
		}
		if (numErrors > 0) {
			chart_data[count] = numErrors;
			legend[count] = '%%.%% - Error';
			colors[count++] = '#ff0000'; 
		}
		pie = r.piechart(290, 190, 120, chart_data, {
			legend : legend,
			legendpos : "east",
			colors : colors
		});
		label = r.label(128,40,"Overall errors vs. successes");
	}
	</script>
	<style type="text/css">
		@import "css/overcast/jquery-ui-1.10.1.custom.min.css";
		@import "css/main.css";
	</style>
	<title>Fixity Check Details</title>
</head>
<body>
	<div class="roundbox">
		<h1>Fedora 4 - Fixity Check Details</h1>
	</div>
	<div class="clearfix" id="wrap">
		<div id="left_col">
			<div id="piechart" class="roundbox"></div>
		</div>
		<div id="right_col">
			<div class="roundbox" id="dataTableDiv">
				<table id="details" width="100%">
					<thead>
						<tr>
							<th>Id</th>
							<th>Datastream id</th>
							<th>Timestamp</th> 
							<th>Result</th>
							<th>Details</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
					<tfoot>
						<tr>
							<th>Id</th>
							<th>Datastream id</th>
							<th>Timestamp</th> 
							<th>Result</th>
							<th>Details</th>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>
	</div>
</body>
</html>